{% extends "base.html" %}
{% block content %}
{% set title = "Devices" %}

<script>
function autoHideResult(deviceId, ms = 10000) {
  const box = document.getElementById(`result-${deviceId}`);
  if (!box) return;

  // cancel any previous timer for this device
  if (box._hideTimer) clearTimeout(box._hideTimer);

  box._hideTimer = setTimeout(() => {
    box.classList.add("hidden");
    // optional: clear content too
    // box.innerHTML = "";
  }, ms);
}

async function runPing(deviceId) {
    const url = `/ping/${deviceId}/`;

    try {
        const res = await fetch(url, { method: "POST" });
        const data = await res.json();

        const box = document.getElementById(`result-${deviceId}`);
        if (!box) return;

        box.classList.remove("hidden");

        // Status label + color
        const isSuccess = data.status === "success";
        const statusLabel = isSuccess ? "‚úî Ping Success" : "‚úò Ping Failed";

        box.classList.toggle("text-green-700", isSuccess);
        box.classList.toggle("text-red-700", !isSuccess);

        // Close button
        const closeButton = `
            <button
                onclick="document.getElementById('result-${deviceId}').classList.add('hidden')"
                class="text-gray-500 hover:text-black ml-2"
                style="font-size: 16px; font-weight: bold; line-height: 12px;"
            >√ó</button>
        `;

        // Clean output
        const output = data.output || "";

        // Build final HTML
        box.innerHTML = `
            <div class="p-3 bg-gray-100 rounded border relative">

                <div class="flex justify-between items-center mb-2">
                    <strong>${statusLabel}</strong>
                    ${closeButton}
                </div>

                <pre class="bg-white p-2 rounded text-xs whitespace-pre-wrap leading-tight border">
                    ${output}
                </pre>
            </div>
        `;
        autoHideResult(deviceId,10000);

    } catch (err) {
        console.error("Ping request error:", err);
    }
}

async function runBackup(deviceId) {
    const url = `/backup/run/${deviceId}/`;

    try {
        const res = await fetch(url, { method: "POST" });
        const data = await res.json();

        const box = document.getElementById(`result-${deviceId}`);
        if (!box) return;

        box.classList.remove("hidden");

        const isSuccess = data.status === "success";
        const statusLabel = isSuccess ? "‚úî Backup Success" : "‚úò Backup Failed";

        box.classList.toggle("text-green-700", isSuccess);
        box.classList.toggle("text-red-700", !isSuccess);

        const closeButton = `
            <button
                onclick="document.getElementById('result-${deviceId}').classList.add('hidden')"
                class="text-gray-500 hover:text-black ml-2"
                style="font-size: 16px; font-weight: bold; line-height: 12px;"
            >√ó</button>
        `;

        const logFile = data.logfile || "";

        box.innerHTML = `
            <div class="p-3 bg-gray-100 rounded border relative">

                <div class="flex justify-between items-center mb-2">
                    <strong>${statusLabel}</strong>
                    ${closeButton}
                </div>

                <pre class="bg-white p-2 rounded text-xs whitespace-pre-wrap leading-tight border">
                    Log saved at:
                    ${logFile}
                </pre>
            </div>
        `;
        autoHideResult(deviceId,10000);

    } catch (err) {
        console.error("Backup request error:", err);
    }
}

async function runRestart(deviceId) {
  // 1) get uptime first
  let uptimeText = null;

  try {
    const ures = await fetch(`/restart/uptime/${deviceId}/`, { method: "POST" });
    const udata = await ures.json();
    console.log("uptime api:", udata); // TEMP: debug

    if (udata && udata.uptime) {
    uptimeText = udata.uptime; // use it even if status=fail
    }
  } catch (e) {
    console.warn("Uptime fetch failed:", e);
  }

  // 2) confirm with uptime
  const msg = uptimeText
    ? `Device uptime:\n${uptimeText}\n\nAre you sure you want to restart this device?`
    : "Are you sure you want to restart this device?";

  const ok = confirm(msg);
  if (!ok) return;

  // 3) run restart
  const url = `/restart/run/${deviceId}/`;

  const box = document.getElementById(`result-${deviceId}`);
  if (!box) return;

  box.classList.remove("hidden");
  box.classList.remove("text-green-700", "text-red-700");
  box.innerHTML = `
    <div class="p-3 bg-gray-100 rounded border relative">
      <div class="flex justify-between items-center mb-2">
        <strong>‚è≥ Restart requested...</strong>
        <button
          onclick="document.getElementById('result-${deviceId}').classList.add('hidden')"
          class="text-gray-500 hover:text-black ml-2"
          style="font-size: 16px; font-weight: bold; line-height: 12px;"
        >√ó</button>
      </div>
      <pre class="bg-white p-2 rounded text-xs whitespace-pre-wrap leading-tight border">Please wait...</pre>
    </div>
  `;

  try {
    const res = await fetch(url, { method: "POST" });
    const data = await res.json();

    const isSuccess = data.status === "success";
    const statusLabel = isSuccess ? "‚úî Restart Triggered" : "‚úò Restart Failed";

    box.classList.toggle("text-green-700", isSuccess);
    box.classList.toggle("text-red-700", !isSuccess);

    const closeButton = `
      <button
        onclick="document.getElementById('result-${deviceId}').classList.add('hidden')"
        class="text-gray-500 hover:text-black ml-2"
        style="font-size: 16px; font-weight: bold; line-height: 12px;"
      >√ó</button>
    `;

    const output = data.output || "";
    const logFile = data.logfile || "";

    box.innerHTML = `
      <div class="p-3 bg-gray-100 rounded border relative">
        <div class="flex justify-between items-center mb-2">
          <strong>${statusLabel}</strong>
          ${closeButton}
        </div>
        <pre class="bg-white p-2 rounded text-xs whitespace-pre-wrap leading-tight border">
            ${output}

            Log:
            ${logFile}
        </pre>
      </div>
    `;
    autoHideResult(deviceId,15000);
  } catch (err) {
    console.error("Restart request error:", err);
  }
}

async function runDiff(deviceId) {
  const url = `/backup/diff/${deviceId}/?max_lines=400`;

  try {
    const res = await fetch(url, { method: "POST" });
    const data = await res.json();

    const box = document.getElementById(`result-${deviceId}`);
    if (!box) return;

    box.classList.remove("hidden");

    const isSuccess = data.status === "success";
    const statusLabel = isSuccess ? "‚úî Diff Generated" : "‚úò Diff Failed";

    box.classList.toggle("text-green-700", isSuccess);
    box.classList.toggle("text-red-700", !isSuccess);

    const closeButton = `
      <button
        onclick="document.getElementById('result-${deviceId}').classList.add('hidden')"
        class="text-gray-500 hover:text-black ml-2"
        style="font-size: 16px; font-weight: bold; line-height: 12px;"
      >√ó</button>
    `;

    const diffText = data.diff || data.message || "";
    const logFile = data.logfile || "";
    const fromTo = (data.from && data.to) ? `${data.from}  ->  ${data.to}` : "";

    box.innerHTML = `
      <div class="p-3 bg-gray-100 rounded border relative">
        <div class="flex justify-between items-center mb-2">
          <strong>${statusLabel}</strong>
          ${closeButton}
        </div>

        ${fromTo ? `<div class="text-xs text-gray-600 mb-2">${fromTo}</div>` : ""}

        <pre class="bg-white p-2 rounded text-xs whitespace-pre-wrap leading-tight border">${diffText}</pre>

        ${logFile ? `<div class="text-xs text-gray-600 mt-2">Log: ${logFile}</div>` : ""}
      </div>
    `;
    autoHideResult(deviceId,10000);
  } catch (err) {
    console.error("Diff request error:", err);
  }
}

</script>
<div class="grid grid-cols-1 md:grid-cols-2 gap-6">

    <!-- LEFT: DATACENTER / CORE DEVICES -->
    <div class="bg-white rounded shadow p-6">
        <h2 class="text-xl font-bold mb-4">üè¢ DC / Core Devices ({{ core_devices|length }})</h2>

        <ul class="space-y-3">
        {% for d in core_devices %}
            <li class="border rounded p-4">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="font-semibold">{{ d.name }}</p>
                        <p class="text-sm text-gray-600">{{ d.ip }}</p>
                    </div>

                    <div class="flex space-x-2">
                        <button onclick="runPing('{{ d.id }}')"
                                class="bg-yellow-600 text-white px-3 py-1 rounded hover:bg-yellow-700">
                            Ping
                        </button>

                        <button onclick="runBackup('{{ d.id }}')"
                                class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">
                            Backup
                        </button>
                    </div>
                </div>

                <!-- Result area -->
                <div id="result-{{ d.id }}" class="mt-2 hidden"></div>
            </li>
        {% endfor %}
        </ul>
    </div>


    <!-- RIGHT: BRANCH DEVICES GROUPED BY VENDOR -->
    <div class="bg-white rounded shadow p-6">
        <h2 class="text-xl font-bold mb-4">üåø Branch Devices</h2>

        {% for vendor, devices in branch_by_vendor.items() %}
        <details class="mb-4">
            <summary class="cursor-pointer text-lg font-semibold py-2">
                {{ vendor }} ({{ devices|length }})
            </summary>

            <ul class="mt-3 space-y-3 ml-3">
            {% for d in devices %}
                <li class="border rounded p-4">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-semibold">{{ d.name }}</p>
                            <p class="text-sm text-gray-600">{{ d.ip }}</p>
                        </div>

                        <div class="flex space-x-2">
                            <button onclick="runPing('{{ d.id }}')"
                                    class="bg-yellow-600 text-white px-3 py-1 rounded hover:bg-yellow-700">
                                Ping
                            </button>

                            <button onclick="runRestart('{{ d.id }}')"
                                    class="bg-green-600 text-white px-3 py-1 rounded hover:bg-blue-700">
                                Restart
                            </button>

                            <button onclick="runBackup('{{ d.id }}')"
                                    class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">
                                Backup
                            </button>

                            <button onclick="runDiff('{{ d.id }}')"
                                class="bg-purple-600 text-white px-3 py-1 rounded hover:bg-purple-700">
                                Diff
                            </button>


                        </div>
                    </div>

                    <!-- Result area -->
                    <div id="result-{{ d.id }}" class="mt-2 hidden"></div>
                </li>
            {% endfor %}
            </ul>
        </details>
        {% endfor %}
    </div>

</div>
{% endblock %}
