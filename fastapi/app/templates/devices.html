{% extends "base.html" %}
{% block content %}
{% set title = "Devices" %}

<script>
async function runPing(deviceId) {
    const url = `/ping/${deviceId}/`;

    try {
        const res = await fetch(url, { method: "POST" });
        const data = await res.json();

        const box = document.getElementById(`result-${deviceId}`);
        if (!box) return;

        box.classList.remove("hidden");

        // Status label + color
        const isSuccess = data.status === "success";
        const statusLabel = isSuccess ? "‚úî Ping Success" : "‚úò Ping Failed";

        box.classList.toggle("text-green-700", isSuccess);
        box.classList.toggle("text-red-700", !isSuccess);

        // Close button
        const closeButton = `
            <button
                onclick="document.getElementById('result-${deviceId}').classList.add('hidden')"
                class="text-gray-500 hover:text-black ml-2"
                style="font-size: 16px; font-weight: bold; line-height: 12px;"
            >√ó</button>
        `;

        // Clean output
        const output = data.output || "";

        // Build final HTML
        box.innerHTML = `
            <div class="p-3 bg-gray-100 rounded border relative">

                <div class="flex justify-between items-center mb-2">
                    <strong>${statusLabel}</strong>
                    ${closeButton}
                </div>

                <pre class="bg-white p-2 rounded text-xs whitespace-pre-wrap leading-tight border">
                    ${output}
                </pre>
            </div>
        `;

    } catch (err) {
        console.error("Ping request error:", err);
    }
}

async function runBackup(deviceId) {
    const url = `/backup/run/${deviceId}/`;

    try {
        const res = await fetch(url, { method: "POST" });
        const data = await res.json();

        const box = document.getElementById(`result-${deviceId}`);
        if (!box) return;

        box.classList.remove("hidden");

        const isSuccess = data.status === "success";
        const statusLabel = isSuccess ? "‚úî Backup Success" : "‚úò Backup Failed";

        box.classList.toggle("text-green-700", isSuccess);
        box.classList.toggle("text-red-700", !isSuccess);

        const closeButton = `
            <button
                onclick="document.getElementById('result-${deviceId}').classList.add('hidden')"
                class="text-gray-500 hover:text-black ml-2"
                style="font-size: 16px; font-weight: bold; line-height: 12px;"
            >√ó</button>
        `;

        const logFile = data.logfile || "";

        box.innerHTML = `
            <div class="p-3 bg-gray-100 rounded border relative">

                <div class="flex justify-between items-center mb-2">
                    <strong>${statusLabel}</strong>
                    ${closeButton}
                </div>

                <pre class="bg-white p-2 rounded text-xs whitespace-pre-wrap leading-tight border">
                    Log saved at:
                    ${logFile}
                </pre>
            </div>
        `;

    } catch (err) {
        console.error("Backup request error:", err);
    }
}

</script>
<div class="grid grid-cols-1 md:grid-cols-2 gap-6">

    <!-- LEFT: DATACENTER / CORE DEVICES -->
    <div class="bg-white rounded shadow p-6">
        <h2 class="text-xl font-bold mb-4">üè¢ DC / Core Devices ({{ core_devices|length }})</h2>

        <ul class="space-y-3">
        {% for d in core_devices %}
            <li class="border rounded p-4">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="font-semibold">{{ d.name }}</p>
                        <p class="text-sm text-gray-600">{{ d.ip }}</p>
                    </div>

                    <div class="flex space-x-2">
                        <button onclick="runPing('{{ d.id }}')"
                                class="bg-yellow-600 text-white px-3 py-1 rounded hover:bg-yellow-700">
                            Ping
                        </button>

                        <button onclick="runBackup('{{ d.id }}')"
                                class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">
                            Backup
                        </button>
                    </div>
                </div>

                <!-- Result area -->
                <div id="result-{{ d.id }}" class="mt-2 hidden"></div>
            </li>
        {% endfor %}
        </ul>
    </div>


    <!-- RIGHT: BRANCH DEVICES GROUPED BY VENDOR -->
    <div class="bg-white rounded shadow p-6">
        <h2 class="text-xl font-bold mb-4">üåø Branch Devices</h2>

        {% for vendor, devices in branch_by_vendor.items() %}
        <details class="mb-4">
            <summary class="cursor-pointer text-lg font-semibold py-2">
                {{ vendor }} ({{ devices|length }})
            </summary>

            <ul class="mt-3 space-y-3 ml-3">
            {% for d in devices %}
                <li class="border rounded p-4">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-semibold">{{ d.name }}</p>
                            <p class="text-sm text-gray-600">{{ d.ip }}</p>
                        </div>

                        <div class="flex space-x-2">
                            <button onclick="runPing('{{ d.id }}')"
                                    class="bg-yellow-600 text-white px-3 py-1 rounded hover:bg-yellow-700">
                                Ping
                            </button>

                            <button onclick="runBackup('{{ d.id }}')"
                                    class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">
                                Backup
                            </button>
                        </div>
                    </div>

                    <!-- Result area -->
                    <div id="result-{{ d.id }}" class="mt-2 hidden"></div>
                </li>
            {% endfor %}
            </ul>
        </details>
        {% endfor %}
    </div>

</div>
{% endblock %}
